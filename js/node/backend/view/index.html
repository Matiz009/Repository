<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full CRUD Post Manager</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and basic setup */
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-200">
        <h1 class="text-4xl font-extrabold text-indigo-800 mb-8 border-b pb-4">
            Post Manager (Local API CRUD)
        </h1>

        <!-- API Status Information -->
        <p class="text-sm text-gray-500 mb-6">
            Connecting to API base: 
            <code class="bg-gray-100 text-sm p-1 rounded font-mono">http://localhost:5000/api/v1</code>
        </p>

        <!-- 1. CREATE POST FORM -->
        <section id="create-post-section" class="mb-10 p-6 bg-indigo-50 border border-indigo-200 rounded-lg shadow-inner">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">Create New Post</h2>
            <form id="createPostForm" onsubmit="handleCreatePost(event)" class="space-y-4">
                <div>
                    <label for="postTitle" class="block text-sm font-medium text-gray-700">Title</label>
                    <input type="text" id="postTitle" required 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <!-- NEW AUTHOR FIELD TO MATCH MONGODB SCHEMA -->
                <div>
                    <label for="postAuthor" class="block text-sm font-medium text-gray-700">Author</label>
                    <input type="text" id="postAuthor" required 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <!-- CONTENT FIELD (Mismatched 'body' ID kept for simplicity but data variable renamed) -->
                <div>
                    <label for="postBody" class="block text-sm font-medium text-gray-700">Content</label>
                    <textarea id="postBody" required rows="3"
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <button type="submit" id="createPostButton"
                        class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 transition duration-150">
                    Add Post
                </button>
                <div id="formMessage" class="text-sm pt-2"></div>
            </form>
        </section>

        <!-- 2. READ AND DELETE POSTS SECTION -->
        <section id="read-posts-section">
            <h2 class="text-2xl font-bold text-gray-700 mb-4 flex justify-between items-center">
                Existing Posts
                <button id="getPostsButton" 
                        onclick="getPosts()"
                        class="px-4 py-2 bg-gray-500 text-white text-sm font-medium rounded-md shadow-sm hover:bg-gray-600 transition duration-150">
                    Refresh Posts
                </button>
            </h2>

            <!-- Container for posts, loading, and error messages -->
            <div id="postsContainer" class="mt-4">
                <p class="text-gray-400 italic" id="initialMessage">
                    Click "Refresh Posts" to load data from the server.
                </p>
            </div>
        </section>
    </div>

    <script>
        // Global element references
        const postsContainer = document.getElementById('postsContainer');
        const createPostForm = document.getElementById('createPostForm');
        const createPostButton = document.getElementById('createPostButton');
        const formMessage = document.getElementById('formMessage');
        const initialMessage = document.getElementById('initialMessage');
        
        // --- API Configuration ---
        const API_BASE_URL = 'http://localhost:5000/api/v1'; 

        // Initial fetch on load to show existing data
        window.onload = () => {
             // Delay to allow DOM to settle, then call getPosts
             setTimeout(getPosts, 100); 
        };

        /**
         * Utility to display status messages (success/error)
         * @param {string} msg The message to display
         * @param {string} type 'success' or 'error'
         */
        function displayMessage(element, msg, type = 'success') {
            element.innerHTML = msg;
            element.className = 'text-sm mt-2 p-2 rounded-md font-medium ' + 
                                (type === 'success' 
                                    ? 'bg-green-100 text-green-700' 
                                    : 'bg-red-100 text-red-700');
            setTimeout(() => { element.innerHTML = ''; element.className = 'text-sm pt-2'; }, 4000);
        }

        /**
         * 1. READ: Fetches all posts from the server and renders them.
         */
        async function getPosts() {
            if (initialMessage) initialMessage.remove();
            
            // Set loading state
            postsContainer.innerHTML = `
                <div class="flex items-center space-x-2 text-indigo-600 p-4">
                    <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Loading posts from your server...</span>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE_URL}/posts`);

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const posts = await response.json();

                if (posts && Array.isArray(posts) && posts.length > 0) {
                    const postHtml = posts.map((post) => { 
                        // Use keys matching the schema: _id, title, content, and author
                        const id = post._id || post.id || 'N/A'; // Use _id for MongoDB
                        const title = post.title || 'Untitled Post';
                        const content = post.content || post.body || 'No content.'; // Now prioritize 'content'
                        const author = post.author || 'Unknown Author'; // Get the author field

                        return `
                            <li class="bg-white p-5 rounded-lg shadow-md border border-gray-100 mb-4 flex justify-between items-start">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800 mb-1">${title}</h3>
                                    <p class="text-sm text-indigo-500 font-medium mb-1">Author: ${author}</p>
                                    <p class="text-sm text-gray-500 font-medium mb-3">ID: ${id}</p>
                                    <p class="text-gray-700">${content}</p>
                                </div>
                                <button onclick="deletePost('${id}')"
                                        class="ml-4 flex-shrink-0 px-3 py-1 bg-red-500 text-white text-xs font-semibold rounded-full hover:bg-red-600 transition duration-150">
                                    Delete
                                </button>
                            </li>
                        `;
                    }).join('');

                    postsContainer.innerHTML = `
                        <ul class="list-none p-0 divide-y divide-gray-200">
                            ${postHtml}
                        </ul>
                    `;
                } else {
                    postsContainer.innerHTML = `
                        <div class="text-center p-6 bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 rounded-lg">
                            <p class="font-bold">No Posts Found</p>
                            <p>The server responded successfully, but there are no posts yet.</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error("Fetch error:", error);
                postsContainer.innerHTML = `
                    <div class="text-center p-6 bg-red-50 border-l-4 border-red-500 text-red-800 rounded-lg">
                        <p class="font-bold">Connection Error!</p>
                        <p>Could not load posts. Ensure your server is running and CORS is configured correctly.</p>
                        <p class="text-xs mt-2">Details: ${error.message}</p>
                    </div>
                `;
            }
        }

        /**
         * 2. CREATE: Handles the form submission to create a new post.
         */
        async function handleCreatePost(event) {
            event.preventDefault(); // Stop the form from performing a traditional submit
            
            const titleInput = document.getElementById('postTitle');
            const bodyInput = document.getElementById('postBody');
            const authorInput = document.getElementById('postAuthor'); // New input for Author

            const newPost = {
                title: titleInput.value.trim(),
                content: bodyInput.value.trim(), // KEY CHANGED to 'content' to match MongoDB schema
                author: authorInput.value.trim()  // NEW FIELD to match MongoDB schema
            };

            if (!newPost.title || !newPost.content || !newPost.author) {
                displayMessage(formMessage, 'Title, Content, and Author are required.', 'error');
                return;
            }

            createPostButton.disabled = true;
            createPostButton.textContent = 'Adding...';

            try {
                const response = await fetch(`${API_BASE_URL}/create-post`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newPost)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();
                
                // Success: Clear form, show message, and refresh list
                titleInput.value = '';
                bodyInput.value = '';
                authorInput.value = ''; // Clear new author input
                displayMessage(formMessage, 'Post created successfully!', 'success');
                getPosts(); 

            } catch (error) {
                console.error("Create post error:", error);
                displayMessage(formMessage, `Failed to create post: ${error.message}`, 'error');
            } finally {
                createPostButton.disabled = false;
                createPostButton.textContent = 'Add Post';
            }
        }

        /**
         * 3. DELETE: Sends a request to delete a post by its ID.
         * @param {string} postId The ID of the post to delete.
         */
        async function deletePost(postId) {
            // Note: Use a custom modal instead of confirm() for production environments
            if (!confirm('Are you sure you want to delete this post?')) {
                return;
            }

            try {
                // The DELETE endpoint uses the ID in the URL path
                const response = await fetch(`${API_BASE_URL}/posts/${postId}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                // Success: Show temporary message in form area and refresh list
                displayMessage(formMessage, `Post ID ${postId} deleted successfully!`, 'success');
                getPosts(); 

            } catch (error) {
                console.error("Delete post error:", error);
                displayMessage(formMessage, `Failed to delete post: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
